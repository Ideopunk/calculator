<!DOCTYPE html>
<html>
    <head>
        <title>
            Calculator
        </title>
        <style>

            @font-face {
                    font-family: 'pockcalc';
                    src: local('POCKC___.TTF');
                    src: url(POCKC___.TTF);
                }

            #calc {
                background-color: hsl(138, 100%, 88%);
                border: 3px solid hsl(137, 100%, 84%);;
                border-radius: 3px;
                width: 410px;
                height: 420px;
                display: grid;
                grid-template-rows: 1fr 6fr;
            }

            #display {
                background-color: hsl(202, 80%, 72%);
                border-radius: 3px;
                margin: 15px;
                height: 50px;
                text-align: end;
                box-shadow: 0.5px 1px 1px 1px hsl(202, 43%, 57%);
            }

            #buttons {
                display: grid;
                grid-template-columns: 4fr 3fr;
                position: relative;
                left: 1.5px;
            }

            #digits {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                align-self: center;
            }

            #operators {
                display: inline-block;
                justify-self: center;
                align-self: center;
            }

            #notequal {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
            }

            button {
                background-color: hsl(234, 79%, 68%);
                width: 75px;
                height: 75px;
                border: 1px solid hsl(234, 79%, 68%);
                margin: 3px;
                font-size: 30px;
                font-family: Courier, monospace;
                border-radius: 3px;
                box-shadow: 0.5px 1px 1px 1px hsl(234, 30%, 41%);
            }

            .op {
                height: 92.8px;
            }

            .letters {
                height: 40px;
            }

            p {
                position: relative;
                top: -50px;
                left: -8px;
                font-size: 50px;
            }

            .font {
                font-family: 'pockcalc', 'Courier New', Courier, monospace;
            }

            #backspace {
                font-size: 50px;
                color:hsl(240, 5%, 12%)
            }

            #equals {
                width: 96%;
            }

            .repo {
                position:relative;
                top: 3px;
            }

        </style>
    </head>
<body>

<div id='calc'>
    <div id='display'>
        <p id='displaytext' class='font'></p>
    </div>
    <div id='buttons'>
        <div id='digits'>
            <button value='7' class='btn'><div class='repo'>7</div></button>
            <button value='8' class='btn'><div class='repo'>8</div></button>
            <button value='9' class='btn'><div class='repo'>9</div></button>
            <button value='4' class='btn'><div class='repo'>4</div></button>
            <button value='5' class='btn'><div class='repo'>5</div></button>
            <button value='6' class='btn'><div class='repo'>6</div></button>
            <button value='1' class='btn'><div class='repo'>1</div></button>
            <button value='2' class='btn'><div class='repo'>2</div></button>
            <button value='3' class='btn'><div class='repo'>3</div></button>
            <button value='0' class='btn'><div class='repo'>0</div></button>
            <button value='.' id='decimal' class='dig'><div class='repo'>.</div></button>
            <button value='Backspace' id='backspace'><div class='repo'>âŒ«</div></button>
        </div>
        <div id='operators'>
                <div id='notequal'>
                <button value='*' class='op btn'><div class='repo'>*</div></button>
                <button value='/' class='op btn'><div class='repo'>/</div></button>
                <button value='+' class='op btn'><div class='repo'>+</div></button>
                <button value='-' class='op btn'><div class='repo'>-</div></button>
                <button value='r' class='letters' id='round'><div class='repo'>R</div></button>
                <button value='c' class='letters' id='clear'><div class='repo'>C</div></button>
            </div>
            <div id='yesequal'>
                <button value='=' id='equals'><div class='repo'>=</div></button>
            </div>
        </div>
    </div>
</div>

<script>

// update display with digit or operator
function display(value) {
    let currVal = document.querySelector('#displaytext').textContent;
    let newExpression = '' + currVal + value;
    if (newExpression.match(/[+\-/*][+/*]/) ) {
        alert("Operators can only operate on numbers");
        return;
    } else if (newExpression.length > 16) {
        alert("Sorry, this calculator only has so much space.")
        return;
    }
    document.querySelector('#displaytext').textContent = newExpression;
}

// update display with decimal
function decimalize() {
    let currVal = document.querySelector('#displaytext').textContent;
    let lastNum = currVal.match(/[\d.]+$/)
    if (lastNum === null) {
        display('.')
    } else if (lastNum[0].includes('.')) {
        alert("There's already a decimal here :)")
        return;
    } else {
        display('.')
    }
}

function backspace() {
    let currVal = document.querySelector('#displaytext').textContent;
    document.querySelector('#displaytext').textContent = currVal.slice(0, -1);
}

function clear() { document.querySelector('#displaytext').textContent = ''; }

function add(a, b) { return (a + b); }

function subtract(a, b) { 
    return (a - b); 
}

function multiply(a, b) { 
    let x = a / b;
    x = x.toString()
    if (x.includes('.')) {
        while (x.length > 14) {
            x = rounder(x);
        }
    }
    return (a * b); }

function rounder(a) {
    let trailingDig = a.match(/\d\.\d+$/);
    if (trailingDig === null) {
        return a;
    }
    let len = trailingDig[0].length;

    // Swap out number for rounded number.
    let newEnd = Number(trailingDig[0]).toFixed(len - 3);
    a = a.replace(/\d\.\d+$/, newEnd)
    return a;
}

function divide(a, b) { 
    let x = a / b;
    x = x.toString()
    while (x.length > 14) {
        x = rounder(x);
    }
    return (parseFloat(x));
}

// choose operator
function operate(a, b, sign) {
    if (sign === "+") {
        result = add(a, b);
    } else if (sign === '-') {
        result = subtract(a, b);
    } else if (sign === '*') {
        result = multiply(a, b);
    } else if (sign === '/') {
        result = divide(a, b);
    }
    return result;
}

// prepare display string for operation
function regexMathCut(string, regexMath) {
    while(string.match(regexMath)) {
        let match = string.match(regexMath)
        if (match[1].match(/^\./)) {
            match[1] = match[1].replace(/^/, 0)
        }
        let a = Number(match[1])
        let sign = match[2]
        if (match[3].match(/^\./)) {
            match[3] = match[3].replace(/^/, 0)
        }
        let b = Number(match[3])
        result = operate(a, b, sign)
        string = string.replace(regexMath, result)
    }
    return string;
}

function equals() {
    let currEquation = document.querySelector('#displaytext').textContent;

    // get rid of erronous operators at beginning and end of string
    currEquation = currEquation.replace(/^[+/*]/, '')
    currEquation = currEquation.replace(/[-+/*]$/, '')

    // If there is an operator in the equation, work through all the operators until only a number remains.
    while (currEquation.match(/[\d.][+*/-]+[\d.]/)) {
        // beDMas 
        let dmExpress = /([-\d.]+)([*/])([-\d.]+)/
        currEquation = regexMathCut(currEquation, dmExpress)

        // bedmAS
        let asExpress = /([-\d.]+)([-+])([-\d.]+)/
        currEquation = regexMathCut(currEquation, asExpress)
    }

    if (currEquation === 'Infinity') {
        alert('No')
        clear();
    } else if (currEquation.toString().length > 15) {
        currEquation = rounder(currEquation);
        if (currEquation.includes('.')) {
            currEquation = currEquation.replace(/0+$/, '')
        }
        document.querySelector('#displaytext').textContent = currEquation;
    } else {
        document.querySelector('#displaytext').textContent = currEquation;
    }
}

// initialize digit and operator buttons
let buttons = document.querySelectorAll('.btn');
buttons.forEach((button) => {
    button.addEventListener('click', () => {
        display(button.textContent);
    });
});

let equalSign = document.querySelector('#equals')
equalSign.addEventListener('click', () => {
    equals();
})

// initialize non-operator function buttons
let CC = document.querySelector('#clear')
CC.addEventListener('click', () => {
    clear();
});

let roundBtn = document.querySelector('#round');
roundBtn.addEventListener('click', () => {
    let currDisplay = document.querySelector('#displaytext').textContent;
    document.querySelector('#displaytext').textContent = rounder(currDisplay);
})

let deci = document.querySelector('#decimal')
deci.addEventListener('click', () => {
    decimalize();
});

let bs = document.querySelector('#backspace')
bs.addEventListener('click', () => {
    backspace();
});

// initialize keyboard functionality
window.addEventListener('keydown', function(e) {
    const buttonInput = document.querySelector(`button[value="${e.key}"]`)
    if(!buttonInput) return;
    buttonInput.click()
});

</script>
</body>
</html>